<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Desserts Shop</title>
  <meta name="description" content="Carrito de compras con HTML, CSS y JavaScript. Guarda el carrito en localStorage y genera factura con IVA del 13% (El Salvador)."/>

  <style>
    :root{
      --brand:#ff7f50; --brand-dark:#ff4500; --ink:#222; --bg:#fffaf7; --card:#fff; --muted:#666;
      --radius:12px; --shadow:0 8px 24px rgba(0,0,0,.08); --border:#e9e6e3;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
    header{position:sticky;top:0;z-index:5;background:var(--brand);color:#fff;padding:14px 20px;display:flex;gap:14px;align-items:center;justify-content:space-between}
    header h1{margin:0;font-size:clamp(18px,2.4vw,24px)}
    .search-login{display:flex;align-items:center;gap:8px}
    .search-login input{padding:10px 12px;border-radius:10px;border:0;outline:0;min-width:200px}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 14px;border:0;border-radius:10px;background:#1f2937;color:#fff;cursor:pointer}
    .btn:hover{background:#111827}
    .btn.primary{background:var(--brand)}
    .btn.primary:hover{background:var(--brand-dark)}

    main{display:grid;grid-template-columns:1.2fr .8fr;gap:22px;padding:22px;align-items:start}

    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .card .pad{padding:14px}
    .product__img{width:100%;aspect-ratio:4/3;object-fit:cover;display:block}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .price{font-weight:700}
    .muted{color:var(--muted)}
    .qty{display:flex;align-items:center;gap:6px}
    .qty input{width:80px;padding:8px;border:1px solid #ccc;border-radius:10px}

    aside{display:flex;flex-direction:column;gap:20px}
    .panel{background:var(--card);border:2px solid #333;border-radius:var(--radius);box-shadow:var(--shadow)}
    .panel h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--border)}
    .panel .body{padding:12px 14px}

    ul.clean{list-style:none;margin:0;padding:0}
    .cart-li{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:8px 0;border-bottom:1px dashed var(--border)}
    .cart-li:last-child{border-bottom:0}
    .thumb{width:72px;height:60px;border-radius:8px;object-fit:cover}
    .cart-meta{font-size:14px}
    .actions{display:flex;align-items:center;gap:6px}
    .btn.icon{padding:8px 10px;border-radius:8px}

    .total{display:flex;justify-content:space-between;font-weight:700;margin-top:10px}
    .totals p{display:flex;justify-content:space-between;margin:6px 0}

    .empty{padding:14px;border:1px dashed var(--border);border-radius:10px;background:#faf7f4}

    footer{padding:26px;text-align:center;color:var(--muted)}

    @media (max-width:1100px){
      main{grid-template-columns:1fr}
      .grid{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:700px){
      .grid{grid-template-columns:1fr}
    }
  </style>

  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <header>
    <h1>Desserts Shop üç∞</h1>
    <div class="search-login">
      <label for="search" class="visually-hidden" aria-hidden="true" style="position:absolute;left:-9999px">Buscar</label>
      <input id="search" type="search" placeholder="Buscar postre‚Ä¶" autocomplete="off" />
      <button class="btn" id="loginBtn" type="button">Iniciar sesi√≥n</button>
    </div>
  </header>

  <main>
    <section>
      <div class="row" style="margin-bottom:10px">
        <p class="muted" id="resultsMsg">Mostrando todos los productos</p>
        <button class="btn" id="resetBtn" type="button">Limpiar filtro</button>
      </div>
      <div id="product-list" class="grid" aria-live="polite"></div>
    </section>

    <aside>
      <section class="panel" aria-live="polite" aria-busy="false">
        <h2>Carrito</h2>
        <div class="body">
          <ul id="cart-items" class="clean"></ul>
          <div id="cart-empty" class="empty" style="display:none">Tu carrito est√° vac√≠o üõí</div>
          <div class="total"><span>Total</span><span id="cart-total">$0.00</span></div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="clearBtn" type="button">Vaciar</button>
            <button class="btn primary" id="checkoutBtn" type="button">Comprar</button>
          </div>
        </div>
      </section>

      <section id="invoice" class="panel" style="display:none">
        <h2>Factura üßæ</h2>
        <div class="body">
          <ul id="invoice-items" class="clean"></ul>
          <div class="totals">
            <p><span>Subtotal</span><span id="invoice-subtotal">$0.00</span></p>
            <p><span>IVA (13%)</span><span id="invoice-tax">$0.00</span></p>
            <p class="total"><span>Total</span><span id="invoice-total">$0.00</span></p>
          </div>
          <button class="btn" id="continueBtn" type="button">Seguir comprando</button>
        </div>
      </section>
    </aside>
  </main>

  <footer>
    UDB Virtual + Derechos Reservados 2025 + JavaScript
  </footer>

  <script>
    // Helpers defensivos por si $/$$ no est√°n definidos a√∫n
    if(!window.$){ window.$ = (sel)=>document.querySelector(sel); }
    if(!window.$$){ window.$$ = (sel)=>document.querySelectorAll(sel); }

    // Captura global de errores (no dejar la p√°gina "en blanco")
    window.addEventListener('error', (e)=>{
      try{
        const msg = (e?.error?.message || e.message || 'Error desconocido');
        if(window.Swal){ Swal.fire({icon:'error', title:'Error en la p√°gina', text: msg}); }
        else{ alert('Error: ' + msg); }
      }catch(err){ console.error('Error handler failed', err); }
      console.error('GlobalError:', e?.error||e);
    });

    // ===== Utilidades =====
    const fmt = new Intl.NumberFormat('es-SV',{style:'currency', currency:'USD', minimumFractionDigits:2});
    // (definidas arriba) const $ = sel => document.querySelector(sel);
    // (definidas arriba) const $$ = sel => document.querySelectorAll(sel);

    // ===== Notificaciones (SweetAlert2 con fallback) =====
    const notify = {
      error(msg){ if(window.Swal){ Swal.fire({icon:'error', title:'Error', text: msg}); } else { alert(msg); } },
      success(msg){ if(window.Swal){ Swal.fire({icon:'success', title:'Listo', text: msg, timer:1400, showConfirmButton:false}); } else { alert(msg); } },
      toast(msg, icon='success'){
        if(window.Swal){
          const Toast = Swal.mixin({toast:true, position:'top-end', showConfirmButton:false, timer:2000, timerProgressBar:true});
          Toast.fire({icon, title: msg});
        } else { console.log(icon.toUpperCase()+': '+msg); }
      },
      confirm(msg){
        if(window.Swal){
          return Swal.fire({icon:'question', title:'¬øConfirmar?', text: msg, showCancelButton:true, confirmButtonText:'S√≠', cancelButtonText:'Cancelar'});
        } else { return Promise.resolve({isConfirmed: confirm(msg)}); }
      }
    };

    // ===== Datos =====
    const initialProducts = [
      { id:1, name:"Pistachio Baklava", price:4.00,  stock:10, img:"assets/images/image-baklava-desktop.jpg" },
      { id:2, name:"Waffle with Berries", price:6.50, stock:8,  img:"assets/images/image-waffle-desktop.jpg" },
      { id:3, name:"Vanilla Bean Cr√®me Br√ªl√©e", price:7.00, stock:5,  img:"assets/images/image-creme-brulee-desktop.jpg" },
      { id:4, name:"Macaron", price:8.00, stock:12, img:"assets/images/image-macaron-desktop.jpg" },
      { id:5, name:"Classic Tiramisu", price:5.50, stock:9,  img:"assets/images/image-tiramisu-desktop.jpg" },
      { id:6, name:"Meringue Pie", price:5.00, stock:7,  img:"assets/images/image-meringue-desktop.jpg" },
      { id:7, name:"Cake", price:4.50, stock:6,  img:"assets/images/image-cake-desktop.jpg" },
      { id:8, name:"Salted Caramel Brownie", price:5.50, stock:10, img:"assets/images/image-brownie-desktop.jpg" },
      { id:9, name:"Vanilla Panna Cotta", price:6.50, stock:8,  img:"assets/images/image-panna-cotta-desktop.jpg" }
    ];

    // Estado persistente
    const STORAGE_KEY = 'desserts_cart_v1';
    function loadCart(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }catch{ return []; } }
    function saveCart(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(cart)); }

    let cart = loadCart();
    const products = (window.structuredClone ? structuredClone(initialProducts) : JSON.parse(JSON.stringify(initialProducts))); // fallback

    // ===== Render Productos =====
    const list = $('#product-list');
    const resultsMsg = $('#resultsMsg');

    function availableStock(p){
      const inCart = cart.find(i=>i.id===p.id)?.quantity || 0;
      return Math.max(0, p.stock - inCart);
    }

    function productCard(p){
      const stockAvail = availableStock(p);
      const disabled = stockAvail === 0 ? 'disabled' : '';
      return `
        <article class="card" data-id="${p.id}">
          <img class="product__img" src="${p.img}" alt="${p.name}" onerror="this.src='https://picsum.photos/seed/dessert${p.id}/640/480'"/>
          <div class="pad">
            <h3 style="margin:0 0 6px 0;font-size:18px">${p.name}</h3>
            <div class="row"><span class="price">${fmt.format(p.price)}</span><span class="muted">Stock: ${stockAvail}</span></div>
            <div class="row" style="margin-top:10px">
              <div class="qty">
                <label for="qty-${p.id}" class="visually-hidden" style="position:absolute;left:-9999px">Cantidad</label>
                <input id="qty-${p.id}" type="number" min="1" value="1" max="${stockAvail}" ${disabled} />
              </div>
              <button class="btn primary add" type="button" ${disabled}>Agregar</button>
            </div>
          </div>
        </article>`;
    }

    function renderProducts(filter=''){
      const norm = filter.trim().toLowerCase();
      const filtered = initialProducts.filter(p=>p.name.toLowerCase().includes(norm));
      list.innerHTML = filtered.map(productCard).join('');
      resultsMsg.textContent = norm ? `Resultados para "${filter}" (${filtered.length})` : 'Mostrando todos los productos';
    }

    // Delegaci√≥n: clicks en Agregar
    list.addEventListener('click', (e)=>{
      const btn = e.target.closest('button.add');
      if(!btn) return;
      const card = e.target.closest('[data-id]');
      const id = Number(card.dataset.id);
      const product = products.find(p=>p.id===id);
      const input = card.querySelector('input[type="number"]');
      const qty = parseInt(input.value,10);
      addToCart(product, qty);
      notify.toast(`${product.name} agregado al carrito`);
    });

    // B√∫squeda (debounce)
    let t; $('#search').addEventListener('input', (e)=>{
      clearTimeout(t); const val = e.target.value; t = setTimeout(()=>renderProducts(val), 150);
    });
    $('#resetBtn').addEventListener('click', ()=>{ $('#search').value=''; renderProducts(''); });

    // ===== Carrito =====
    const cartList = $('#cart-items');
    const cartTotal = $('#cart-total');

    function ensureQty(q){ return Number.isFinite(q) && q>0 ? Math.floor(q) : 1; }

    function addToCart(product, quantity){
      const q = ensureQty(quantity);
      const avail = availableStock(product);
      if(q>avail){ notify.error('No hay suficiente stock disponible.'); return; }
      const item = cart.find(i=>i.id===product.id);
      if(item){ item.quantity += q; }
      else{ cart.push({ id:product.id, name:product.name, price:product.price, img:product.img, quantity:q }); }
      saveCart();
      renderCart();
      renderProducts($('#search').value);
    }

    function updateItemQty(id, nextQty){
      const item = cart.find(i=>i.id===id);
      if(!item) return;
      const product = products.find(p=>p.id===id);
      const q = Math.max(1, Math.floor(nextQty));
      const can = product.stock - (cart.filter(i=>i.id===id).reduce((s,i)=>s+i.quantity,0) - item.quantity);
      if(q>can){ notify.error('No puedes exceder el stock disponible.'); return; }
      item.quantity = q;
      saveCart();
      renderCart();
      renderProducts($('#search').value);
    }

    function removeFromCart(id){
      cart = cart.filter(i=>i.id!==id);
      saveCart();
      renderCart();
      renderProducts($('#search').value);
    }

    function clearCart(){ cart = []; saveCart(); renderCart(); renderProducts($('#search').value); }

    function line(item){
      const lineTotal = item.price * item.quantity;
      return `
        <li class="cart-li" data-id="${item.id}">
          <img class="thumb" src="${item.img}" alt="${item.name}" onerror="this.src='https://picsum.photos/seed/cart${item.id}/160/120'"/>
          <div>
            <strong>${item.name}</strong>
            <div class="cart-meta muted">${item.quantity} √ó ${fmt.format(item.price)} = <strong>${fmt.format(lineTotal)}</strong></div>
            <div class="actions" style="margin-top:6px">
              <button class="btn icon dec" type="button" aria-label="Quitar uno">‚àí</button>
              <input class="qtyInput" type="number" min="1" value="${item.quantity}" />
              <button class="btn icon inc" type="button" aria-label="Agregar uno">+</button>
              <button class="btn icon rm" type="button" aria-label="Eliminar">‚ùå</button>
            </div>
          </div>
          <div class="price">${fmt.format(lineTotal)}</div>
        </li>`;
    }

    function renderCart(){
      if(cart.length===0){
        cartList.innerHTML='';
        $('#cart-empty').style.display='block';
        cartTotal.textContent = fmt.format(0);
        return;
      }
      $('#cart-empty').style.display='none';
      cartList.innerHTML = cart.map(line).join('');
      const total = cart.reduce((s,i)=>s+i.price*i.quantity,0);
      cartTotal.textContent = fmt.format(total);
    }

    // Delegaci√≥n de eventos del carrito
    cartList.addEventListener('click', (e)=>{
      const li = e.target.closest('.cart-li');
      if(!li) return;
      const id = Number(li.dataset.id);
      if(e.target.closest('.rm')) return removeFromCart(id);
      if(e.target.closest('.inc')){ const item = cart.find(i=>i.id===id); updateItemQty(id, item.quantity+1); return; }
      if(e.target.closest('.dec')){ const item = cart.find(i=>i.id===id); const next = Math.max(1, item.quantity-1); updateItemQty(id, next); return; }
    });
    cartList.addEventListener('change', (e)=>{
      const input = e.target.closest('.qtyInput');
      if(!input) return;
      const li = e.target.closest('.cart-li');
      const id = Number(li.dataset.id);
      updateItemQty(id, Number(input.value));
    });

    // Vaciar con confirmaci√≥n
    $('#clearBtn').addEventListener('click', async ()=>{
      const res = await notify.confirm('¬øVaciar todos los productos del carrito?');
      if(res.isConfirmed) { clearCart(); notify.success('Carrito vaciado'); }
    });

    // ===== Facturaci√≥n =====
    const IVA = 0.13;
    $('#checkoutBtn').addEventListener('click', ()=>{
      if(cart.length===0){ notify.error('Tu carrito est√° vac√≠o üõí'); return; }
      const invoice = $('#invoice');
      const ul = $('#invoice-items');
      ul.innerHTML = cart.map(i=>`
        <li class="cart-li">
          <img class="thumb" src="${i.img}" alt="${i.name}"/>
          <div>${i.name} ‚Äî ${i.quantity} √ó ${fmt.format(i.price)}</div>
          <div class="price">${fmt.format(i.price*i.quantity)}</div>
        </li>`).join('');
      const subtotal = cart.reduce((s,i)=>s+i.price*i.quantity,0);
      const tax = +(subtotal*IVA).toFixed(2);
      const total = subtotal + tax;
      $('#invoice-subtotal').textContent = fmt.format(subtotal);
      $('#invoice-tax').textContent = fmt.format(tax);
      $('#invoice-total').textContent = fmt.format(total);
      invoice.style.display='block';

      // Guardar una copia simple de la √∫ltima factura
      localStorage.setItem('desserts_last_invoice', JSON.stringify({when:new Date().toISOString(), items:cart, subtotal, tax, total}));

      clearCart();
    });

    $('#continueBtn').addEventListener('click', ()=>{ $('#invoice').style.display='none'; });

    // ===== Login simulado =====
    $('#loginBtn').addEventListener('click', ()=> notify.toast('Funci√≥n de inicio de sesi√≥n pr√≥ximamente üîê','info'));

    // ===== Inicializaci√≥n =====
    try{ renderProducts(''); renderCart(); }
    catch(err){
      console.error(err);
      if(window.Swal){ Swal.fire({icon:'error', title:'No se pudo renderizar', text: err.message}); }
      else { alert('No se pudo renderizar: '+err.message); }
    }
  </script>
</body>
</html>
